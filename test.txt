# Counterparty Features — Category A

**General Counterparty Features: All Transaction Categories**

This section documents the technical construction and outputs of general counterparty features derived from transactional data. All features described here are computed using **all eligible transaction categories**, without category-level filtering.

---

## 1. Overview & Approach

We compute counterparty features by analyzing **all transaction categories** over three fixed time horizons: 3 months, 6 months, and 12 months. For each horizon, we separately process **debit transactions** (money going out) and **credit transactions** (money coming in). This gives us transaction counts, amounts, and concentration metrics at both the counterparty and application levels, plus dynamics showing how counterparties change from month to month.

---

## 2. Key Definitions & Notation

| Symbol | Definition |
|--------|-----------|
| $i$ | Application identifier (`APPLICATION_ID`) |
| $h$ | Time horizon in months: $h \in \{3, 6, 12\}$ |
| $dir$ | Transaction direction: `debit` or `credit` (derived from `ITC1`) |
| $c$ | Counterparty identifier (`CACCT`) |
| $t$ | Individual transaction record |
| $m$ | Month index relative to application date (`difference_in_months`) |
| $D_{i,h}^{dir}(c)$ | Set of transactions matching application $i$, horizon $h$, direction $dir$, and counterparty $c$ |

---

## 3. Counterparty Concentration Features

### 3.1 Amount Aggregation

For each application $i$, horizon $h$, transaction direction $dir$, and counterparty $c$:

**Transaction count per counterparty:**

$$
\mathrm{trx\_count\_per\_cp}_{i,c} = \sum_{t \in D_{i,h}^{dir}(c)} 1
$$

**Transaction amount per counterparty:**

$$
\mathrm{trx\_amount\_per\_cp}_{i,c} = \sum_{t \in D_{i,h}^{dir}(c)} \mathrm{AMOUNT}_t
$$

### 3.2 Application-Level Totals

$$
\mathrm{total\_trx\_count}_i = \sum_c \mathrm{trx\_count\_per\_cp}_{i,c}
$$

$$
\mathrm{total\_trx\_amount}_i = \sum_c \mathrm{trx\_amount\_per\_cp}_{i,c}
$$

### 3.3 Normalized Counterparty Shares

**Transaction count share:**

$$
\mathrm{trx\_count\_percentage}_{i,c} = \frac{\mathrm{trx\_count\_per\_cp}_{i,c}}{\mathrm{total\_trx\_count}_i}
$$

**Transaction amount share:**

$$
\mathrm{trx\_amount\_percentage}_{i,c} = \frac{\mathrm{trx\_amount\_per\_cp}_{i,c}}{\mathrm{total\_trx\_amount}_i}
$$

### 3.4 Concentration Metrics

For each $i, h, dir$:

- **Maximum transaction count share:** $\max_c(\mathrm{trx\_count\_percentage}_{i,c})$
- **Maximum transaction amount share:** $\max_c(\mathrm{trx\_amount\_percentage}_{i,c})$
- **Herfindahl–Hirschman Index (count-based):**

$$
\mathrm{HHI}_{i,h}^{dir} = \sum_c (\mathrm{trx\_count\_percentage}_{i,c})^2
$$

- **Number of distinct counterparties:** $|\{c\}|$

---

## 4. Monthly Counterparty Dynamics

### 4.1 Monthly Counterparty Sets

For each application $i$ and month $m$:

$$
\mathrm{CPSet}_{i,m} = \{c \mid c \text{ appears in at least one transaction in month } m\}
$$

$$
\mathrm{CPCount}_{i,m} = |\mathrm{CPSet}_{i,m}|
$$

### 4.2 Month-on-Month Metrics

For consecutive months $m$ and $m-1$:

**Counterparties lost:**

$$
\mathrm{Lost}_{i,m} = |\mathrm{CPSet}_{i,m-1} \setminus \mathrm{CPSet}_{i,m}|
$$

**Counterparties gained:**

$$
\mathrm{Gained}_{i,m} = |\mathrm{CPSet}_{i,m} \setminus \mathrm{CPSet}_{i,m-1}|
$$

**Churn rate:**

$$
\mathrm{ChurnRate}_{i,m} = \frac{\mathrm{Lost}_{i,m}}{|\mathrm{CPSet}_{i,m-1}|} \quad (\text{if } |\mathrm{CPSet}_{i,m-1}| > 0)
$$

**Acquisition rate:**

$$
\mathrm{AcquisitionRate}_{i,m} = \frac{\mathrm{Gained}_{i,m}}{|\mathrm{CPSet}_{i,m-1}|} \quad (\text{if } |\mathrm{CPSet}_{i,m-1}| > 0)
$$

**Net counterparty change:**

$$
\mathrm{CPDiff}_{i,m} = \mathrm{Gained}_{i,m} - \mathrm{Lost}_{i,m}
$$

**Growth rate:**

$$
\mathrm{GrowthRate}_{i,m} = \mathrm{AcquisitionRate}_{i,m} - \mathrm{ChurnRate}_{i,m}
$$

---

## 5. Horizon-Level Aggregation

For each application $i$, horizon $h$, and transaction direction $dir$, monthly metrics are aggregated using:

- mean
- standard deviation
- minimum
- maximum

Metrics aggregated include:
- Counterparty count
- Churn rate
- Acquisition rate
- Counterparties gained
- Counterparties lost
- Net counterparty change
- Growth rate

---

## 6. Feature Naming Convention & Examples

Category A features follow a naming pattern that encodes:
- Borrower type (main or joint/co-borrower)
- Horizon (3m, 6m, or 12m)
- Transaction direction (debit or credit)
- Metric computed
- Aggregation type (mean, std, min, max)

### Example 1: Acquisition Rate Volatility

**Feature name:** `f_cp_jco_12m_credit_acquisition_rate_std`

- `f_cp_jco` → counterparty feature for joint/co-borrower
- `12m` → 12-month horizon
- `credit` → credit transactions only
- `acquisition_rate` → metric: monthly rate of new counterparties
- `std` → standard deviation across months

**Meaning:** Standard deviation of monthly counterparty acquisition rate over 12 months using credit transactions.

### Example 2: Counterparty Count Volatility

**Feature name:** `f_cp_jco_12m_debit_count_of_cp_std`

- `f_cp_jco` → joint/co-borrower
- `12m` → 12-month horizon
- `debit` → debit transactions only
- `count_of_cp` → metric: number of distinct counterparties per month
- `std` → standard deviation across months

**Meaning:** Standard deviation of monthly distinct counterparty count over 12 months using debit transactions.

### Example 3: Net Counterparty Change

**Feature name:** `f_cp_jco_3m_credit_cp_diff_std`

- `f_cp_jco` → joint/co-borrower
- `3m` → 3-month horizon
- `credit` → credit transactions only
- `cp_diff` → metric: net change (gained minus lost) counterparties per month
- `std` → standard deviation across months

**Meaning:** Standard deviation of monthly net counterparty change (acquisition minus churn) over 3 months using credit transactions.
